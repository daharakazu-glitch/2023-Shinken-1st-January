<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>2023年度 1月 進研模試 英語 解答・解説 重要語句復習アプリ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700&family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['"Inter"', '"Noto Sans JP"', 'sans-serif'],
                    },
                    colors: {
                        brand: {
                            50: '#f0f9ff',
                            100: '#e0f2fe',
                            500: '#0ea5e9',
                            600: '#0284c7',
                            700: '#0369a1',
                        }
                    },
                    animation: {
                        'fade-in': 'fadeIn 0.3s ease-out forwards',
                    },
                    keyframes: {
                        fadeIn: {
                            '0%': { opacity: '0', transform: 'translateY(10px)' },
                            '100%': { opacity: '1', transform: 'translateY(0)' },
                        }
                    }
                }
            }
        }
    </script>
    <style>
        body {
            background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
            min-height: 100vh;
            touch-action: manipulation;
        }
        .card {
            background-color: rgba(255, 255, 255, 0.95);
            border-radius: 16px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            padding: 24px;
            border: 1px solid rgba(255, 255, 255, 0.7);
        }
        @media (min-width: 640px) {
            .card { padding: 32px; }
        }
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 12px 24px;
            border-radius: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            user-select: none;
        }
        .btn:active { transform: scale(0.96); }
        .btn-primary { background: #0ea5e9; color: white; box-shadow: 0 4px 6px -1px rgba(14, 165, 233, 0.3); }
        .btn-primary:hover { background: #0284c7; box-shadow: 0 6px 8px -1px rgba(14, 165, 233, 0.4); }
        .btn-secondary { background: white; color: #475569; border: 1px solid #e2e8f0; }
        .btn-secondary:hover { background: #f8fafc; border-color: #cbd5e1; }
        .btn-green { background: #10b981; color: white; }
        .btn-red { background: #ef4444; color: white; }
        .btn-orange { background: #f97316; color: white; }
        .btn-disabled { background: #cbd5e1; color: #94a3b8; cursor: not-allowed; transform: none !important; box-shadow: none !important; }
        
        .hidden { display: none !important; }
        
        /* Quiz & Flashcard Styles */
        .quiz-option {
            border: 2px solid #f1f5f9;
            padding: 16px;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.2s;
            background: white;
            position: relative;
            overflow: hidden;
        }
        .quiz-option:hover { border-color: #0ea5e9; background-color: #f0f9ff; }
        .quiz-option:active { transform: scale(0.98); }
        .quiz-option.correct { border-color: #10b981; background-color: #d1fae5; color: #065f46; }
        .quiz-option.incorrect { border-color: #ef4444; background-color: #fee2e2; color: #991b1b; }
        
        #mic-icon.recording { animation: pulse-red 1.5s infinite; color: white; }
        @keyframes pulse-red {
            0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); }
            70% { transform: scale(1.1); box-shadow: 0 0 0 10px rgba(239, 68, 68, 0); }
            100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); }
        }

        .word-checkbox {
            width: 1.25rem;
            height: 1.25rem;
            color: #0ea5e9;
            border-radius: 0.25rem;
            border-color: #cbd5e1;
            cursor: pointer;
        }

        /* Scrollbar styling */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f5f9; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
    </style>
</head>
<body class="text-slate-800 antialiased">

    <div id="app" class="max-w-4xl mx-auto p-4 sm:p-8">
        <header class="text-center mb-10">
            <div class="inline-block p-2 bg-white rounded-2xl shadow-sm mb-4">
                <span class="px-3 py-1 bg-brand-100 text-brand-600 rounded-lg text-xs font-bold tracking-wider uppercase">Study App</span>
            </div>
            <h1 class="text-2xl sm:text-3xl md:text-4xl font-extrabold text-slate-900 tracking-tight leading-tight">
                <span class="text-brand-600">2023年度 1月 進研模試 英語</span><br>
                解答・解説 重要語句復習
            </h1>
        </header>

        <!-- Setup Section -->
        <section id="setup-section" class="card space-y-8 animate-fade-in">
            <div>
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-bold text-slate-800 flex items-center">
                        <span class="flex items-center justify-center w-8 h-8 rounded-full bg-brand-100 text-brand-600 text-sm mr-3">1</span>
                        学習する単語を選択
                    </h2>
                    <div class="flex space-x-2">
                        <button id="select-all" class="text-xs font-medium text-brand-600 hover:text-brand-700 hover:bg-brand-50 px-3 py-1.5 rounded-lg transition">すべて選択</button>
                        <button id="deselect-all" class="text-xs font-medium text-slate-500 hover:text-slate-700 hover:bg-slate-100 px-3 py-1.5 rounded-lg transition">すべて解除</button>
                    </div>
                </div>
                
                <div class="bg-slate-50 border border-slate-200 rounded-xl p-4">
                    <div id="word-list" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-3 max-h-[50vh] overflow-y-auto pr-2">
                        <!-- Words injected by JS -->
                        <div class="col-span-full text-center text-slate-400 py-8">データ読み込み中...</div>
                    </div>
                </div>
            </div>

            <div>
                <h2 class="text-xl font-bold text-slate-800 mb-4 flex items-center">
                    <span class="flex items-center justify-center w-8 h-8 rounded-full bg-brand-100 text-brand-600 text-sm mr-3">2</span>
                    学習モードを選択
                </h2>
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                    <label class="relative flex items-center p-4 border border-slate-200 rounded-xl cursor-pointer hover:bg-slate-50 hover:border-brand-300 transition-all group bg-white">
                        <input type="radio" name="mode" value="word" class="peer sr-only" checked>
                        <div class="w-5 h-5 border-2 border-slate-300 rounded-full mr-3 peer-checked:border-brand-500 peer-checked:bg-brand-500 relative"></div>
                        <div class="flex flex-col">
                            <span class="font-bold text-slate-700 peer-checked:text-brand-700">単語・フレーズのみ</span>
                            <span class="text-xs text-slate-500 mt-1">基本的な意味を覚える</span>
                        </div>
                        <div class="absolute inset-0 border-2 border-transparent peer-checked:border-brand-500 rounded-xl pointer-events-none"></div>
                    </label>
                    <label class="relative flex items-center p-4 border border-slate-200 rounded-xl cursor-pointer hover:bg-slate-50 hover:border-brand-300 transition-all group bg-white">
                        <input type="radio" name="mode" value="sentence" class="peer sr-only">
                        <div class="w-5 h-5 border-2 border-slate-300 rounded-full mr-3 peer-checked:border-brand-500 peer-checked:bg-brand-500 relative"></div>
                        <div class="flex flex-col">
                            <span class="font-bold text-slate-700 peer-checked:text-brand-700">例文で学習</span>
                            <span class="text-xs text-slate-500 mt-1">文脈から推測・リスニング</span>
                        </div>
                        <div class="absolute inset-0 border-2 border-transparent peer-checked:border-brand-500 rounded-xl pointer-events-none"></div>
                    </label>
                </div>
            </div>

            <div class="pt-4 flex flex-col sm:flex-row gap-4 justify-center items-center border-t border-slate-100">
                <button id="start-learning-btn" class="btn btn-primary w-full sm:w-auto text-lg min-w-[200px] shadow-lg">
                    <i class="fas fa-play mr-2 text-sm"></i> 学習を開始
                </button>
                <button id="quick-test-btn" class="btn btn-orange w-full sm:w-auto text-lg shadow-md">
                    <i class="fas fa-random mr-2"></i> ランダムテスト
                </button>
                <button id="download-pdf-btn" class="btn btn-green w-full sm:w-auto text-lg shadow-md">
                    <i class="fas fa-file-pdf mr-2 text-white"></i> PDF作成
                </button>
            </div>
        </section>

        <!-- Learning Section -->
        <section id="learning-section" class="card hidden flex flex-col h-auto min-h-[600px]">
            <div class="flex justify-between items-center mb-6">
                 <button id="back-to-setup-btn" class="text-sm text-slate-500 hover:text-slate-800 flex items-center transition font-medium">
                    <i class="fas fa-arrow-left mr-2"></i> 戻る
                </button>
                <div class="bg-slate-100 px-4 py-1.5 rounded-full">
                    <span id="progress-indicator" class="text-sm font-bold text-slate-600 font-mono"></span>
                </div>
                <div class="w-16"></div> <!-- Spacer for centering -->
            </div>
            
            <div class="flex-grow flex flex-col justify-center mb-8">
                <div id="flashcard-container" class="relative w-full cursor-pointer group">
                    <div class="relative w-full min-h-[350px] bg-white rounded-2xl border-2 border-slate-100 shadow-sm hover:border-brand-200 transition-all duration-300 flex flex-col items-center justify-center p-8 text-center">
                        <div class="w-full flex flex-col items-center">
                            <div id="illustration-area" class="hidden mb-6 text-brand-500">
                                <i class="fas fa-book-open text-5xl opacity-80"></i>
                            </div>
                            <p id="english-text" class="text-3xl sm:text-4xl md:text-5xl font-bold text-slate-800 mb-6 leading-tight select-text"></p>
                            <div id="japanese-wrapper" class="h-auto min-h-[4rem] transition-all duration-300 opacity-0 transform translate-y-4">
                                <p id="japanese-text" class="text-xl sm:text-2xl text-brand-600 font-medium"></p>
                            </div>
                            <p class="text-xs text-slate-400 mt-8 uppercase tracking-widest font-bold">Tap to Reveal</p>
                        </div>
                    </div>
                </div>
                <div id="pronunciation-feedback-container" class="mt-6 min-h-[60px]"></div>
            </div>

            <div class="mt-auto">
                <div class="flex justify-center items-center space-x-6 mb-8">
                    <button id="speak-btn" class="btn btn-secondary rounded-full w-14 h-14 p-0 flex items-center justify-center shadow-sm hover:shadow-md border-brand-200" title="音声を聞く">
                        <i class="fas fa-volume-up text-xl text-brand-600"></i>
                    </button>
                    <button id="record-btn" class="btn btn-red rounded-full w-16 h-16 p-0 flex items-center justify-center shadow-lg hover:shadow-xl transform hover:-translate-y-1 transition-all" title="発音練習">
                        <i id="mic-icon" class="fas fa-microphone text-2xl"></i>
                    </button>
                    <button id="play-recording-btn" class="btn btn-green btn-disabled rounded-full w-14 h-14 p-0 flex items-center justify-center shadow-sm" disabled title="自分の声を聞く">
                        <i class="fas fa-play text-xl"></i>
                    </button>
                </div>
                <audio id="recording-player" class="hidden"></audio>

                <div class="flex justify-between items-center gap-2">
                    <button id="prev-btn" class="btn btn-secondary px-4 sm:px-6"><i class="fas fa-chevron-left mr-2"></i> <span class="hidden sm:inline">前へ</span></button>
                    <button id="start-test-btn" class="btn btn-primary flex-grow sm:flex-grow-0 px-8 shadow-md hover:shadow-lg">テストへ <i class="fas fa-graduation-cap ml-2"></i></button>
                    <button id="next-btn" class="btn btn-secondary px-4 sm:px-6"><span class="hidden sm:inline">次へ</span> <i class="fas fa-chevron-right ml-2"></i></button>
                </div>
            </div>
        </section>

        <!-- Test Options Section -->
        <section id="test-options-section" class="card hidden text-center py-16">
            <h2 class="text-3xl font-bold text-slate-800 mb-8">テスト問題数を選択</h2>
            <div id="test-choices" class="flex flex-wrap justify-center gap-4 mb-12"></div>
            <button id="back-to-learning-btn" class="text-slate-500 hover:text-slate-800 font-medium">キャンセルして戻る</button>
        </section>

        <!-- Quiz Section -->
        <section id="quiz-section" class="card hidden">
            <div class="flex justify-between items-center mb-6 pb-4 border-b border-slate-100">
                 <h2 class="text-xl font-bold text-slate-800 flex items-center">
                    <i class="fas fa-pen-fancy text-brand-500 mr-2"></i> テスト中 
                    <span id="quiz-progress" class="ml-3 text-sm bg-brand-100 text-brand-700 px-2 py-1 rounded-md font-mono"></span>
                </h2>
                 <button id="abort-test-btn" class="text-sm text-red-500 hover:text-red-700 font-medium">中断</button>
            </div>
            <div class="mb-8 text-center">
                <p class="text-xs text-slate-400 mb-2 uppercase font-bold tracking-widest">Question</p>
                <p id="quiz-question" class="text-2xl sm:text-3xl md:text-4xl font-bold text-slate-800 mb-8 leading-relaxed"></p>
                <div id="quiz-options" class="grid grid-cols-1 sm:grid-cols-2 gap-4 text-left"></div>
            </div>
            <div id="feedback" class="text-center font-bold my-4 min-h-[40px] flex items-center justify-center text-lg"></div>
            <div class="text-center h-14">
                 <button id="next-question-btn" class="hidden btn btn-primary px-8 shadow-md">次へ <i class="fas fa-arrow-right ml-2"></i></button>
            </div>
        </section>

        <!-- Results Section -->
        <section id="results-section" class="card hidden text-center py-12 animate-fade-in">
            <div class="mb-2 text-slate-500 font-bold uppercase tracking-wider">Your Score</div>
            <div class="mb-6"><span class="text-6xl font-extrabold text-brand-600 tracking-tight" id="score-percentage"></span></div>
            <p id="score-text" class="text-xl text-slate-600 mb-10 font-medium"></p>
            
            <div id="incorrect-answers-container" class="text-left bg-red-50 border border-red-100 rounded-xl p-6 mb-8 hidden">
                <h3 class="text-lg font-bold text-red-800 mb-4 flex items-center"><i class="fas fa-exclamation-circle mr-2"></i> 復習リスト</h3>
                <ul id="incorrect-answers-list" class="space-y-3"></ul>
            </div>

            <div class="flex flex-col sm:flex-row justify-center gap-4">
                <button id="restart-btn" class="btn btn-primary shadow-lg"><i class="fas fa-redo mr-2"></i> もう一度</button>
                <button id="back-to-home-btn" class="btn btn-secondary">ホームに戻る</button>
            </div>
        </section>
    </div>

    <!-- PDF Modal -->
    <div id="pdf-modal" class="hidden fixed inset-0 bg-slate-900/60 backdrop-blur-sm z-50 flex items-center justify-center p-4 transition-opacity duration-300">
        <div class="bg-white rounded-2xl w-full max-w-lg overflow-hidden shadow-2xl transform transition-all scale-100">
            <div class="bg-slate-50 px-6 py-4 border-b flex justify-between items-center">
                <h3 class="text-lg font-bold text-slate-800"><i class="fas fa-print mr-2 text-brand-500"></i> PDF作成メニュー</h3>
                <button id="close-modal-icon" class="text-slate-400 hover:text-slate-600 w-8 h-8 flex items-center justify-center rounded-full hover:bg-slate-200 transition"><i class="fas fa-times"></i></button>
            </div>
            <div class="p-6 grid grid-cols-1 gap-3">
                <button id="download-list-btn" class="p-4 border rounded-xl hover:bg-brand-50 hover:border-brand-500 text-left font-bold text-slate-700 transition flex items-center group">
                    <span class="w-8 h-8 rounded-full bg-slate-100 text-slate-500 group-hover:bg-brand-500 group-hover:text-white flex items-center justify-center mr-3 text-sm font-bold transition-colors">1</span>
                    単語リスト
                </button>
                <button id="download-en-quiz-btn" class="p-4 border rounded-xl hover:bg-brand-50 hover:border-brand-500 text-left font-bold text-slate-700 transition flex items-center group">
                    <span class="w-8 h-8 rounded-full bg-slate-100 text-slate-500 group-hover:bg-brand-500 group-hover:text-white flex items-center justify-center mr-3 text-sm font-bold transition-colors">2</span>
                    英単語テスト (英→日)
                </button>
                <button id="download-ja-quiz-btn" class="p-4 border rounded-xl hover:bg-brand-50 hover:border-brand-500 text-left font-bold text-slate-700 transition flex items-center group">
                    <span class="w-8 h-8 rounded-full bg-slate-100 text-slate-500 group-hover:bg-brand-500 group-hover:text-white flex items-center justify-center mr-3 text-sm font-bold transition-colors">3</span>
                    和訳テスト (日→英)
                </button>
                <button id="download-mixed-quiz-btn" class="p-4 border rounded-xl hover:bg-brand-50 hover:border-brand-500 text-left font-bold text-slate-700 transition flex items-center group">
                    <span class="w-8 h-8 rounded-full bg-slate-100 text-slate-500 group-hover:bg-brand-500 group-hover:text-white flex items-center justify-center mr-3 text-sm font-bold transition-colors">4</span>
                    混合テスト
                </button>
                <button id="download-sentence-quiz-btn" class="p-4 border rounded-xl hover:bg-brand-50 hover:border-brand-500 text-left font-bold text-slate-700 transition flex items-center group">
                    <span class="w-8 h-8 rounded-full bg-slate-100 text-slate-500 group-hover:bg-brand-500 group-hover:text-white flex items-center justify-center mr-3 text-sm font-bold transition-colors">5</span>
                    例文穴埋め
                </button>
                <button id="download-sentence-mixed-quiz-btn" class="p-4 border rounded-xl hover:bg-brand-50 hover:border-brand-500 text-left font-bold text-slate-700 transition flex items-center group">
                    <span class="w-8 h-8 rounded-full bg-slate-100 text-slate-500 group-hover:bg-brand-500 group-hover:text-white flex items-center justify-center mr-3 text-sm font-bold transition-colors">6</span>
                    例文実戦テスト (穴埋め＆下線部和訳)
                </button>
            </div>
            <div class="bg-slate-50 px-6 py-3 border-t text-right">
                <button id="close-modal-btn" class="text-sm font-bold text-slate-500 hover:text-slate-800 px-4 py-2 rounded-lg hover:bg-slate-200 transition">閉じる</button>
            </div>
        </div>
    </div>

    <script>
        // --- DATA ---
        // Extracted based on 2023 1月 Shinken Mock rules (Excluding Part 2)
        const vocabularyData = [
            // Part 1
            {"english": "take a day off", "japanese": "1日休みを取る", "sentence": "I'm taking a day off from work tomorrow.", "sentence_ja": "明日は仕事を休むわ。"},
            {"english": "have fun", "japanese": "楽しむ", "sentence": "Have fun.", "sentence_ja": "楽しんできなよ。"},
            {"english": "look over", "japanese": "~にざっと目を通す", "sentence": "Could you look over the sales report?", "sentence_ja": "営業報告書にざっと目を通してもらえる？"},
            {"english": "submit", "japanese": "~を提出する", "sentence": "We have to submit it by Friday.", "sentence_ja": "私たちは金曜日までにそれを提出しなければいけない。"},
            {"english": "extra", "japanese": "余分の", "sentence": "I have an extra ticket for the musical tomorrow.", "sentence_ja": "明日のミュージカルのチケットをもう1枚（余分に）持っているんだ。"},
            {"english": "How about -ing?", "japanese": "~しませんか?", "sentence": "How about joining us for some coffee afterwards?", "sentence_ja": "そのあとで一緒にコーヒーでもいかが？"},
            {"english": "on sale", "japanese": "特売で", "sentence": "Look, they're on sale.", "sentence_ja": "見て、特売中よ。"},
            {"english": "fold", "japanese": "~を折りたたむ", "sentence": "I folded the laundry, too.", "sentence_ja": "洗濯物もたたんだわ。"},
            {"english": "laundry", "japanese": "洗濯物", "sentence": "I folded the laundry, too.", "sentence_ja": "洗濯物もたたんだわ。"},
            {"english": "souvenir", "japanese": "土産", "sentence": "Our souvenir sales are doing well.", "sentence_ja": "お土産の販売が好調だね。"},
            {"english": "sale", "japanese": "販売", "sentence": "Our souvenir sales are doing well.", "sentence_ja": "お土産の販売が好調だね。"},
            {"english": "twice as many ... as", "japanese": "~の2倍の...", "sentence": "We sold twice as many pens last year as we did in 2021!", "sentence_ja": "昨年は2021年の2倍の数のペンを売ったよ！"},
            {"english": "I wonder why", "japanese": "なぜなのか(不思議に思う)", "sentence": "I wonder why.", "sentence_ja": "なぜかしら。"},
            {"english": "anymore", "japanese": "もはや~ない", "sentence": "Maybe people just don't send them anymore.", "sentence_ja": "多分人々ははがきをもう送らないだけじゃないかな。"},
            {"english": "focus on", "japanese": "~に焦点を置く", "sentence": "We should focus on other products.", "sentence_ja": "ほかの商品に力を入れた（焦点を置いた）方がいいね。"},

            // Part 3
            {"english": "come out", "japanese": "世に出る、発売される", "sentence": "The Power of Love will be coming out on March 24th.", "sentence_ja": "「The Power of Love」が3月24日に発売される。"},
            {"english": "announcement", "japanese": "告知", "sentence": "We have a special announcement for you.", "sentence_ja": "みんなに特別な告知があるんだ。"},
            {"english": "as you know", "japanese": "ご存じの通り", "sentence": "As you know, our new album will be coming out.", "sentence_ja": "ご存じの通り、新しいアルバムが発売される。"},
            {"english": "be excited about", "japanese": "~にわくわくしている", "sentence": "We're really excited about it.", "sentence_ja": "私たちはそれについて本当にわくわくしている。"},
            {"english": "arrange", "japanese": "~するよう手配する", "sentence": "We've arranged to have a concert here.", "sentence_ja": "ここでコンサートを開くように手配した。"},
            {"english": "that means", "japanese": "つまり~である", "sentence": "That means we'll be returning to this stage.", "sentence_ja": "つまり、このステージに戻ってくるということだよ。"},
            {"english": "rest", "japanese": "残り", "sentence": "Have a great rest of the evening!", "sentence_ja": "このあとも（残りの時間も）すばらしい夜を過ごしてね！"},

            // Grammar / Usage
            {"english": "make ... for", "japanese": "~を...につくってやる", "sentence": "My sister makes dinner for us.", "sentence_ja": "私の姉が夕食を私たちにつくってくれる。"},
            {"english": "toothache", "japanese": "歯痛", "sentence": "I've had a toothache for a week.", "sentence_ja": "1週間歯が痛いんだ。"},
            {"english": "make an appointment", "japanese": "予約する", "sentence": "I'll call and make an appointment.", "sentence_ja": "電話をして予約を入れるよ。"},
            {"english": "lend", "japanese": "~を貸す", "sentence": "Will you lend it to me after she gives it back?", "sentence_ja": "彼女があなたに返したあとで、私に貸してくれる？"},
            {"english": "borrow", "japanese": "~を借りる", "sentence": "Can I borrow it after you read it?", "sentence_ja": "あなたが読んだあと、借りてもいいかな？"},
            {"english": "promise", "japanese": "約束する", "sentence": "I promised to lend it to Kana tomorrow.", "sentence_ja": "カナに明日それを貸すって約束したんだ。"},
            {"english": "convenient", "japanese": "都合がよい", "sentence": "Friday is more convenient.", "sentence_ja": "金曜日の方が都合がいいな。"},
            {"english": "look around", "japanese": "~を見て回る", "sentence": "We'll have only a little time to look around the museum.", "sentence_ja": "美術館を見て回るには少ししか時間がないね。"},

            // Reading 4
            {"english": "define", "japanese": "~を定義する", "sentence": "Culture is difficult to define.", "sentence_ja": "文化とは定義しにくいものである。"},
            {"english": "description", "japanese": "説明", "sentence": "Dictionaries may give a description of culture.", "sentence_ja": "辞書は文化の説明をしているかもしれない。"},
            {"english": "date from", "japanese": "~にさかのぼる", "sentence": "The recipe dates from 1381.", "sentence_ja": "そのレシピは1381年から歴史がある（にさかのぼる）。"},
            {"english": "share", "japanese": "~を共有する", "sentence": "Habits shared by a group of people.", "sentence_ja": "ある集団の人々によって共有される習慣。"},
            {"english": "make sense", "japanese": "道理にかなう", "sentence": "On one level, this makes sense.", "sentence_ja": "あるレベルでは、これは理にかなっている。"},
            {"english": "after all", "japanese": "何しろ", "sentence": "After all, societies are certainly distinct.", "sentence_ja": "何しろ、社会は確かに互いに明らかに違うものである。"},
            {"english": "element", "japanese": "要素", "sentence": "Food is such a vital element of culture.", "sentence_ja": "食べ物は文化の非常に重要な要素だ。"},
            {"english": "represent", "japanese": "~を表す", "sentence": "Certain dishes have come to represent specific cultures.", "sentence_ja": "特定の料理が特定の文化を表すようになった。"},
            {"english": "be linked with", "japanese": "~とつながっている", "sentence": "Apple pie is closely linked with the United States.", "sentence_ja": "アップルパイはアメリカ合衆国と密接につながっている。"},
            {"english": "in fact", "japanese": "実際に", "sentence": "In fact, 'as American as apple pie' is a familiar phrase.", "sentence_ja": "実際に、「極めてアメリカ的な」はおなじみの表現である。"},
            {"english": "flavor", "japanese": "趣、風味", "sentence": "Culture is a fusion of flavors, styles, and ideas.", "sentence_ja": "文化は趣、様式、考えの融合でもある。"},
            {"english": "influence", "japanese": "~に影響を及ぼす", "sentence": "Every language has been influenced by others.", "sentence_ja": "あらゆる言語はほかの言語から影響を受けてきている。"},
            {"english": "roughly", "japanese": "およそ", "sentence": "Roughly a quarter of words come from Old English.", "sentence_ja": "単語のおよそ4分の1は古英語に由来している。"},
            {"english": "approximately", "japanese": "およそ", "sentence": "Approximately one third comes from Latin.", "sentence_ja": "およそ3分の1はラテン語に由来する。"},
            {"english": "divide", "japanese": "~を分ける", "sentence": "Two cultures divided by a common language.", "sentence_ja": "同じ言語で分けられた二つの文化。"},
            {"english": "in reality", "japanese": "実際は", "sentence": "In reality, the opposite is often true.", "sentence_ja": "実際はこの逆であることが多い。"},
            {"english": "as a result", "japanese": "結果として", "sentence": "As a result, some Portuguese teens speak more like Brazilians.", "sentence_ja": "結果として、もっとブラジル人らしく話すポルトガル人の若者がいる。"},
            {"english": "in addition", "japanese": "加えて", "sentence": "In addition, the official spelling follows Brazilian standards.", "sentence_ja": "加えて、公式なつづりは今やブラジルの基準に従っている。"},
            
            // Reading 5
            {"english": "advertisement", "japanese": "広告", "sentence": "You may see advertisements for adventure tours.", "sentence_ja": "冒険ツアーの広告を目にすることがある。"},
            {"english": "adventure", "japanese": "冒険", "sentence": "Advertisements for adventure tours.", "sentence_ja": "冒険ツアーの広告。"},
            {"english": "exotic", "japanese": "珍しい", "sentence": "Adventure tours to exotic places.", "sentence_ja": "珍しい場所への冒険ツアー。"},
            {"english": "live volcano", "japanese": "活火山", "sentence": "You can cycle around a live volcano.", "sentence_ja": "活火山の周りを自転車で回ることができる。"},
            {"english": "requirement", "japanese": "必要条件", "sentence": "Many of these tours have a requirement.", "sentence_ja": "これらのツアーの多くは参加資格の条件（必要条件）がある。"},
            {"english": "raise", "japanese": "集める", "sentence": "Participants must raise money for charity.", "sentence_ja": "参加者は慈善のためにお金を集めなければならない。"},
            {"english": "organization", "japanese": "団体", "sentence": "The organization that sets up this tour.", "sentence_ja": "このツアーを企画する団体。"},
            {"english": "set up", "japanese": "企画する、設立する", "sentence": "The organization that sets up this tour.", "sentence_ja": "このツアーを企画する団体。"},
            {"english": "effort", "japanese": "労力", "sentence": "Give time and effort to raising money.", "sentence_ja": "資金集めに時間と労力を注ぐ。"},
            {"english": "lifetime", "japanese": "一生", "sentence": "A holiday of a lifetime.", "sentence_ja": "一生に一度の休日（旅）。"},
            {"english": "sign up for", "japanese": "~に申し込む", "sentence": "The first thing people must do is sign up for a tour.", "sentence_ja": "人々がまずしなければならないことは、ツアーに申し込むことである。"},
            {"english": "fill up", "japanese": "満ちる、満員になる", "sentence": "Many tours fill up quickly.", "sentence_ja": "多くのツアーはすぐに満員になってしまう。"},
            {"english": "those who", "japanese": "~する人々", "sentence": "Those who sign up must pay a deposit.", "sentence_ja": "申し込む人々は手付金を払う必要がある。"},
            {"english": "in order to", "japanese": "~するために", "sentence": "In order to secure their place.", "sentence_ja": "自分たちの枠を確保するために。"},
            {"english": "minimum", "japanese": "最低限の", "sentence": "Raise a minimum amount of money.", "sentence_ja": "最低限の必要な資金を集める。"},
            {"english": "amount", "japanese": "額", "sentence": "The total amount required is usually high.", "sentence_ja": "必要とされる総額は通常高い。"},
            {"english": "cause", "japanese": "福祉(活動)", "sentence": "Working for an important cause.", "sentence_ja": "重要な福祉に取り組んでいる。"},
            {"english": "sponsorship", "japanese": "資金援助", "sentence": "Ask for sponsorship.", "sentence_ja": "資金援助を頼む。"},
            {"english": "admission", "japanese": "入場料", "sentence": "Guests must pay admission.", "sentence_ja": "ゲストは入場料を払う必要がある。"},
            {"english": "majority", "japanese": "大多数", "sentence": "The majority of adventure tourists collect more.", "sentence_ja": "冒険ツアーに参加する人の大多数はもっと多く集めてしまう。"},
            {"english": "end up -ing", "japanese": "最後には~することになる", "sentence": "They end up collecting more than the minimum.", "sentence_ja": "彼らは最終的に最低限必要な資金よりも多く集めてしまう。"},
            {"english": "question", "japanese": "~を疑問視する", "sentence": "Some people question the morality of this system.", "sentence_ja": "この仕組みの道徳性を疑問視する人もいる。"},
            {"english": "morality", "japanese": "道徳性", "sentence": "Question the morality of this system.", "sentence_ja": "この仕組みの道徳性を疑問視する。"},
            {"english": "at least", "japanese": "少なくとも", "sentence": "At least 60-70 percent goes to charity.", "sentence_ja": "少なくとも60~70パーセントは慈善団体に行く。"},
            {"english": "spend", "japanese": "~して過ごす", "sentence": "Spend their vacation cycling 400 kilometers.", "sentence_ja": "自転車で400キロメートルも走って休暇を過ごす。"},
            {"english": "lounge", "japanese": "のんびり過ごす", "sentence": "When they could lounge on a beach.", "sentence_ja": "ビーチでのんびりできるときに。"},
            {"english": "construction", "japanese": "建設", "sentence": "A young construction worker.", "sentence_ja": "若い建設作業員。"},
            {"english": "hug", "japanese": "~を抱き締める", "sentence": "He hugged everyone else in the group.", "sentence_ja": "彼はグループのほかの人たち全員と抱き合った。"},
            {"english": "take part in", "japanese": "~に参加する", "sentence": "Take part in such an adventure.", "sentence_ja": "あのような冒険に参加する。"},
            {"english": "in need", "japanese": "困窮して", "sentence": "Money went to help people in need.", "sentence_ja": "お金は困っている人を助けることとなった。"},

            // Expression 6
            {"english": "increase", "japanese": "増加する", "sentence": "The number of young people who skip breakfast is increasing.", "sentence_ja": "朝食をとらない若者の数が増えている。"},
            {"english": "serious", "japanese": "深刻な", "sentence": "Skipping breakfast is a serious problem.", "sentence_ja": "朝食をとらないことは深刻な問題だ。"},
            {"english": "encourage", "japanese": "奨励する", "sentence": "I want to encourage students to eat breakfast.", "sentence_ja": "私は生徒たちに朝食をとることを奨励したい。"},
            {"english": "negative effect", "japanese": "弊害、悪影響", "sentence": "Showing negative effects will make the viewer upset.", "sentence_ja": "弊害を示すことは見る者を動揺させるだろう。"},
            {"english": "skip", "japanese": "~を抜く", "sentence": "The negative effects of skipping breakfast.", "sentence_ja": "朝食を抜くことによる弊害。"},
            {"english": "solution", "japanese": "解決策", "sentence": "I don't think that is the best solution.", "sentence_ja": "私はそれが最善の解決策だとは思いません。"}
        ];

        // --- APP STATE ---
        let selectedWords = [];
        let currentWordIndex = 0;
        let learningMode = 'word';
        let quizQuestions = [];
        let currentQuestionIndex = 0;
        let score = 0;
        let incorrectAnswers = [];
        let voices = [];
        let recognition;
        let mediaRecorder;
        let audioChunks = [];
        let recordedAudioURL = null;

        // --- DOM Elements ---
        const els = {
            setupSection: document.getElementById('setup-section'),
            learningSection: document.getElementById('learning-section'),
            testOptionsSection: document.getElementById('test-options-section'),
            quizSection: document.getElementById('quiz-section'),
            resultsSection: document.getElementById('results-section'),
            wordList: document.getElementById('word-list'),
            flashcardContainer: document.getElementById('flashcard-container'),
            englishText: document.getElementById('english-text'),
            japaneseWrapper: document.getElementById('japanese-wrapper'),
            japaneseText: document.getElementById('japanese-text'),
            progressIndicator: document.getElementById('progress-indicator'),
            illustrationArea: document.getElementById('illustration-area'),
            pronunciationFeedback: document.getElementById('pronunciation-feedback-container'),
            micIcon: document.getElementById('mic-icon'),
            recordingPlayer: document.getElementById('recording-player')
        };

        // --- INIT ---
        document.addEventListener('DOMContentLoaded', () => {
            renderWordList();
            initSpeech();
            // Show setup
            switchSection('setup');
        });

        // --- FUNCTIONS ---

        function renderWordList() {
            els.wordList.innerHTML = '';
            vocabularyData.forEach((word, index) => {
                const div = document.createElement('div');
                div.className = 'relative flex items-start p-3 bg-white border border-slate-200 rounded-lg hover:border-brand-300 transition-colors cursor-pointer group';
                div.innerHTML = `
                    <div class="flex items-center h-5">
                        <input type="checkbox" class="word-checkbox" data-index="${index}">
                    </div>
                    <div class="ml-3 text-sm">
                        <label class="font-bold text-slate-800 block cursor-pointer group-hover:text-brand-600">${word.english}</label>
                        <p class="text-slate-500 text-xs mt-1 cursor-pointer">${word.japanese}</p>
                    </div>
                `;
                div.addEventListener('click', (e) => {
                    if (e.target.type !== 'checkbox') {
                        const cb = div.querySelector('input');
                        cb.checked = !cb.checked;
                    }
                });
                els.wordList.appendChild(div);
            });
        }

        function switchSection(name) {
            ['setupSection', 'learningSection', 'testOptionsSection', 'quizSection', 'resultsSection'].forEach(k => {
                els[k].classList.add('hidden');
                els[k].classList.remove('animate-fade-in');
            });
            const target = els[name + 'Section'];
            target.classList.remove('hidden');
            requestAnimationFrame(() => target.classList.add('animate-fade-in'));
        }

        // --- LEARNING LOGIC ---

        function updateCard() {
            const word = selectedWords[currentWordIndex];
            const mode = document.querySelector('input[name="mode"]:checked').value;
            
            // Reset View
            els.japaneseWrapper.classList.remove('opacity-100', 'translate-y-0');
            els.japaneseWrapper.classList.add('opacity-0', 'translate-y-4');
            els.pronunciationFeedback.innerHTML = '';
            els.englishText.className = "text-3xl sm:text-4xl md:text-5xl font-bold text-slate-800 mb-6 leading-tight select-text";

            if (mode === 'sentence' && word.sentence) {
                els.illustrationArea.classList.remove('hidden');
                // Simple highlight logic
                const escapedWord = word.english.replace(/[.*+?^${}()|[\]\\]/g, '\\$&').split(' ')[0]; // Match first word loosely
                const regex = new RegExp(`(${escapedWord}\\w*)`, 'gi');
                els.englishText.innerHTML = word.sentence.replace(regex, '<span class="text-brand-600 border-b-2 border-brand-200">$1</span>');
                els.japaneseText.innerHTML = word.sentence_ja || word.japanese;
                els.englishText.classList.remove('text-5xl');
                els.englishText.classList.add('text-2xl', 'md:text-3xl');
            } else {
                els.illustrationArea.classList.add('hidden');
                els.englishText.textContent = word.english;
                els.japaneseText.textContent = word.japanese;
            }

            els.progressIndicator.textContent = `${currentWordIndex + 1} / ${selectedWords.length}`;
            
            // Button States
            const prevBtn = document.getElementById('prev-btn');
            const nextBtn = document.getElementById('next-btn');
            prevBtn.disabled = currentWordIndex === 0;
            nextBtn.disabled = currentWordIndex === selectedWords.length - 1;
            prevBtn.classList.toggle('opacity-50', prevBtn.disabled);
            nextBtn.classList.toggle('opacity-50', nextBtn.disabled);
        }

        // --- QUIZ LOGIC ---
        function generateQuiz(count) {
            const pool = [...selectedWords].sort(() => 0.5 - Math.random()).slice(0, count);
            quizQuestions = pool.map(w => {
                const correct = w.japanese;
                const distractors = vocabularyData
                    .filter(x => x.japanese !== correct)
                    .sort(() => 0.5 - Math.random())
                    .slice(0, 3)
                    .map(x => x.japanese);
                return {
                    q: w.english,
                    correct,
                    opts: [correct, ...distractors].sort(() => 0.5 - Math.random())
                };
            });
            score = 0;
            currentQuestionIndex = 0;
            incorrectAnswers = [];
            showQuizQuestion();
            switchSection('quiz');
        }

        function showQuizQuestion() {
            const q = quizQuestions[currentQuestionIndex];
            document.getElementById('quiz-question').textContent = q.q;
            document.getElementById('quiz-progress').textContent = `${currentQuestionIndex + 1}/${quizQuestions.length}`;
            const optsEl = document.getElementById('quiz-options');
            optsEl.innerHTML = '';
            document.getElementById('feedback').innerHTML = '';
            document.getElementById('next-question-btn').classList.add('hidden');

            q.opts.forEach(opt => {
                const btn = document.createElement('div');
                btn.className = 'quiz-option text-lg font-medium';
                btn.textContent = opt;
                btn.onclick = () => handleAnswer(btn, opt, q);
                optsEl.appendChild(btn);
            });
        }

        function handleAnswer(btn, ans, q) {
            if (document.querySelector('.quiz-option.correct')) return; // Already answered

            const isCorrect = ans === q.correct;
            if (isCorrect) {
                btn.classList.add('correct');
                document.getElementById('feedback').innerHTML = '<span class="text-green-600"><i class="fas fa-check-circle"></i> 正解!</span>';
                score++;
            } else {
                btn.classList.add('incorrect');
                // Highlight correct
                [...document.querySelectorAll('.quiz-option')].forEach(el => {
                    if (el.textContent === q.correct) el.classList.add('correct');
                });
                document.getElementById('feedback').innerHTML = `<span class="text-red-500"><i class="fas fa-times-circle"></i> 正解: ${q.correct}</span>`;
                incorrectAnswers.push({q: q.q, a: q.correct});
            }
            document.getElementById('next-question-btn').classList.remove('hidden');
        }

        // --- AUDIO ---
        function initSpeech() {
            // Wait for voices to load
            const loadVoices = () => {
                voices = window.speechSynthesis.getVoices();
            };
            
            if ('speechSynthesis' in window) {
                window.speechSynthesis.onvoiceschanged = loadVoices;
                loadVoices(); // Try immediately as well
            }
            
            // Simple check for SpeechRecognition
            window.SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            if (!window.SpeechRecognition) {
                document.getElementById('record-btn').classList.add('btn-disabled');
            }
        }

        function speakText(text) {
            const u = new SpeechSynthesisUtterance(text.replace(/<[^>]*>/g, ''));
            u.lang = 'en-US';
            u.rate = 0.9;
            // Prioritize high-quality US voices (Google US English, etc.)
            const v = voices.find(x => x.name.includes('Google US English')) || 
                      voices.find(x => x.name.includes('Samantha')) ||
                      voices.find(x => x.lang === 'en-US');
            if (v) u.voice = v;
            window.speechSynthesis.speak(u);
        }

        // --- EVENT HANDLERS ---
        document.getElementById('select-all').onclick = () => document.querySelectorAll('.word-checkbox').forEach(c => c.checked = true);
        document.getElementById('deselect-all').onclick = () => document.querySelectorAll('.word-checkbox').forEach(c => c.checked = false);
        
        document.getElementById('start-learning-btn').onclick = () => {
            const checks = document.querySelectorAll('.word-checkbox:checked');
            if (!checks.length) return alert('単語を選択してください');
            selectedWords = Array.from(checks).map(c => vocabularyData[c.dataset.index]);
            currentWordIndex = 0;
            updateCard();
            switchSection('learning');
        };

        document.getElementById('quick-test-btn').onclick = () => {
            const checks = document.querySelectorAll('.word-checkbox:checked');
            if (!checks.length) return alert('単語を選択してください');
            selectedWords = Array.from(checks).map(c => vocabularyData[c.dataset.index]);
            
            // Show options
            const div = document.getElementById('test-choices');
            div.innerHTML = '';
            [10, 20, selectedWords.length].filter((v, i, a) => a.indexOf(v) === i && v <= selectedWords.length).sort((a,b)=>a-b).forEach(n => {
                const b = document.createElement('button');
                b.className = 'btn btn-primary w-24 h-24 flex flex-col items-center justify-center text-xl shadow-lg hover:shadow-xl transition-all';
                b.innerHTML = `<span class="font-bold text-3xl">${n}</span><span class="text-xs">問</span>`;
                b.onclick = () => generateQuiz(n);
                div.appendChild(b);
            });
            switchSection('testOptions');
        };

        // Flashcard interaction
        els.flashcardContainer.onclick = () => {
            els.japaneseWrapper.classList.toggle('opacity-0');
            els.japaneseWrapper.classList.toggle('opacity-100');
            els.japaneseWrapper.classList.toggle('translate-y-4');
            els.japaneseWrapper.classList.toggle('translate-y-0');
        };

        document.getElementById('prev-btn').onclick = () => {
            if (currentWordIndex > 0) { currentWordIndex--; updateCard(); }
        };
        document.getElementById('next-btn').onclick = () => {
            if (currentWordIndex < selectedWords.length - 1) { currentWordIndex++; updateCard(); }
        };
        document.getElementById('speak-btn').onclick = (e) => {
            e.stopPropagation();
            speakText(els.englishText.textContent);
        };

        // Recording
        document.getElementById('record-btn').onclick = async (e) => {
            e.stopPropagation();
            if (!window.SpeechRecognition) return alert('このブラウザは音声認識をサポートしていません');
            
            if (recognition && recognition.started) {
                recognition.stop();
                if (mediaRecorder && mediaRecorder.state === 'recording') mediaRecorder.stop();
                return;
            }

            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                mediaRecorder = new MediaRecorder(stream);
                audioChunks = [];
                mediaRecorder.ondataavailable = e => audioChunks.push(e.data);
                mediaRecorder.onstop = () => {
                    const blob = new Blob(audioChunks, { type: 'audio/wav' });
                    recordedAudioURL = URL.createObjectURL(blob);
                    els.recordingPlayer.src = recordedAudioURL;
                    document.getElementById('play-recording-btn').disabled = false;
                    document.getElementById('play-recording-btn').classList.remove('btn-disabled');
                    els.micIcon.classList.remove('recording');
                    els.micIcon.className = 'fas fa-microphone text-2xl';
                    stream.getTracks().forEach(t => t.stop());
                };
                mediaRecorder.start();

                recognition = new SpeechRecognition();
                recognition.lang = 'en-US';
                recognition.started = true;
                els.micIcon.className = 'fas fa-stop text-2xl';
                els.micIcon.classList.add('recording');
                els.pronunciationFeedback.innerHTML = '<span class="text-brand-500 animate-pulse font-bold">Listening...</span>';

                recognition.onresult = (ev) => {
                    const transcript = ev.results[0][0].transcript;
                    const target = els.englishText.textContent;
                    // Levenshtein
                    const dist = (s, t) => {
                        if (!s.length) return t.length;
                        if (!t.length) return s.length;
                        const arr = [];
                        for (let i = 0; i <= t.length; i++) {
                            arr[i] = [i];
                            for (let j = 1; j <= s.length; j++) {
                                arr[i][j] = Math.min(arr[i - 1][j] + 1, arr[i][j - 1] + 1, arr[i - 1][j - 1] + (s[j - 1].toLowerCase() === t[i - 1].toLowerCase() ? 0 : 1));
                            }
                        }
                        return arr[t.length][s.length];
                    };
                    const d = dist(transcript, target);
                    const max = Math.max(transcript.length, target.length);
                    // Lenient scoring: Boost score slightly
                    const rawScore = Math.max(0, Math.round((1 - d / max) * 100));
                    const score = Math.min(100, Math.round(rawScore * 1.2)); // 20% boost for leniency
                    
                    let msg = '', color = '';
                    if (score > 80) { msg = 'Excellent!'; color = 'text-green-600'; }
                    else if (score > 50) { msg = 'Good job!'; color = 'text-blue-500'; }
                    else { msg = 'Try again'; color = 'text-red-500'; }
                    
                    els.pronunciationFeedback.innerHTML = `
                        <div class="flex flex-col items-center animate-fade-in">
                            <span class="text-xs text-slate-400">You said: "${transcript}"</span>
                            <span class="text-xl font-bold ${color}">${msg} (${score}%)</span>
                        </div>
                    `;
                };
                recognition.onend = () => {
                    recognition.started = false;
                    if (mediaRecorder.state === 'recording') mediaRecorder.stop();
                };
                recognition.start();

            } catch (err) {
                console.error(err);
                alert('マイクへのアクセスを許可してください');
            }
        };

        document.getElementById('play-recording-btn').onclick = (e) => {
            e.stopPropagation();
            els.recordingPlayer.play();
        };

        // Navigation
        document.getElementById('back-to-learning-btn').onclick = () => switchSection('setup');
        document.getElementById('back-to-setup-btn').onclick = () => switchSection('setup');
        document.getElementById('back-to-home-btn').onclick = () => switchSection('setup');
        document.getElementById('abort-test-btn').onclick = () => switchSection('setup');
        
        document.getElementById('next-question-btn').onclick = () => {
            currentQuestionIndex++;
            if (currentQuestionIndex < quizQuestions.length) {
                showQuizQuestion();
            } else {
                // Show results
                document.getElementById('score-percentage').textContent = Math.round(score / quizQuestions.length * 100) + '%';
                document.getElementById('score-text').textContent = `${score} / ${quizQuestions.length} 正解`;
                const list = document.getElementById('incorrect-answers-list');
                list.innerHTML = '';
                if (incorrectAnswers.length) {
                    document.getElementById('incorrect-answers-container').classList.remove('hidden');
                    incorrectAnswers.forEach(item => {
                        const li = document.createElement('li');
                        li.className = "bg-white p-3 rounded border border-red-100 text-sm";
                        li.innerHTML = `<div class="font-bold text-slate-800">${item.q}</div><div class="text-red-500">正解: ${item.a}</div>`;
                        list.appendChild(li);
                    });
                } else {
                    document.getElementById('incorrect-answers-container').classList.add('hidden');
                }
                switchSection('results');
            }
        };

        document.getElementById('start-test-btn').onclick = () => {
            generateQuiz(Math.min(10, selectedWords.length));
        };
        
        document.getElementById('restart-btn').onclick = () => switchSection('setup');

        // PDF
        document.getElementById('download-pdf-btn').onclick = () => document.getElementById('pdf-modal').classList.remove('hidden');
        document.getElementById('close-modal-btn').onclick = () => document.getElementById('pdf-modal').classList.add('hidden');
        document.getElementById('close-modal-icon').onclick = () => document.getElementById('pdf-modal').classList.add('hidden');

        // Reuse PDF logic (simplified for brevity but functional)
        const pdfActions = [
            { id: 'download-list-btn', title: '単語リスト', content: (ws) => `<ul style="column-count:2; gap:40px;">${ws.map(w => `<li style="margin-bottom:10px;"><b>${w.english}</b>: ${w.japanese}</li>`).join('')}</ul>` },
            { id: 'download-en-quiz-btn', title: '英単語テスト', content: (ws) => `<h2>問題</h2><ol>${ws.map(w => `<li style="margin-bottom:15px;">${w.japanese}: ______________</li>`).join('')}</ol><h2 style="page-break-before:always;">解答</h2><ol>${ws.map(w => `<li>${w.english}</li>`).join('')}</ol>` },
            { id: 'download-ja-quiz-btn', title: '和訳テスト', content: (ws) => `<h2>問題</h2><ol>${ws.map(w => `<li style="margin-bottom:15px;">${w.english}: ______________</li>`).join('')}</ol><h2 style="page-break-before:always;">解答</h2><ol>${ws.map(w => `<li>${w.japanese}</li>`).join('')}</ol>` },
            { id: 'download-mixed-quiz-btn', title: '混合テスト', content: (ws) => {
                const shuf = [...ws].sort(()=>0.5-Math.random());
                const qs = shuf.map(w => Math.random()>0.5 ? `${w.japanese}: ______________` : `${w.english}: ______________`);
                const as = shuf.map((w,i) => qs[i].startsWith(w.japanese) ? w.english : w.japanese);
                return `<h2>問題</h2><ol>${qs.map(q=>`<li style="margin-bottom:15px;">${q}</li>`).join('')}</ol><h2 style="page-break-before:always;">解答</h2><ol>${as.map(a=>`<li>${a}</li>`).join('')}</ol>`;
            }},
            { id: 'download-sentence-quiz-btn', title: '例文穴埋め', content: (ws) => {
                const valid = ws.filter(w => w.sentence);
                if (!valid.length) return '例文がありません';
                return `<h2>問題</h2><ol>${valid.map(w => {
                    const k = w.english.split(' ')[0].replace(/[^\w]/g,'');
                    return `<li style="margin-bottom:15px;">${w.sentence.replace(new RegExp(k+'\\w*','i'), '_______')}<br><small>${w.sentence_ja||w.japanese}</small></li>`;
                }).join('')}</ol><h2 style="page-break-before:always;">解答</h2><ol>${valid.map(w=>`<li>${w.english}</li>`).join('')}</ol>`;
            }},
            { id: 'download-sentence-mixed-quiz-btn', title: '例文実戦テスト', content: (ws) => {
                const valid = ws.filter(w => w.sentence);
                if (!valid.length) return '例文がありません';
                const qs = [], as = [];
                valid.sort(()=>0.5-Math.random()).forEach(w => {
                    const k = w.english.split(' ')[0].replace(/[^\w]/g,'');
                    if(Math.random()>0.5) {
                        qs.push(`${w.sentence.replace(new RegExp(k+'\\w*','i'), '_______')}<br><small>${w.sentence_ja||w.japanese}</small>`);
                        as.push(w.english);
                    } else {
                        qs.push(`${w.sentence.replace(new RegExp(`(${k}\\w*)`,'i'), '<u>$1</u>')}<br>下線部和訳: __________________`);
                        as.push(w.japanese);
                    }
                });
                return `<h2>問題</h2><ol>${qs.map(q=>`<li style="margin-bottom:15px;">${q}</li>`).join('')}</ol><h2 style="page-break-before:always;">解答</h2><ol>${as.map(a=>`<li>${a}</li>`).join('')}</ol>`;
            }}
        ];

        pdfActions.forEach(act => {
            document.getElementById(act.id).onclick = () => {
                const checks = document.querySelectorAll('.word-checkbox:checked');
                if (!checks.length) return alert('単語を選択してください');
                const words = Array.from(checks).map(c => vocabularyData[c.dataset.index]);
                const w = window.open('', '_blank');
                w.document.write(`<html><head><title>${act.title}</title><style>body{font-family:sans-serif;margin:30px;}h2{border-bottom:1px solid #000;} ol { padding-left: 20px; } li { margin-left: 10px; }</style></head><body><h1>${act.title}</h1>${act.content(words)}</body></html>`);
                w.document.close();
                setTimeout(() => w.print(), 500);
            };
        });

    </script>
</body>
</html>